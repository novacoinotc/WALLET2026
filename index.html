<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MVP TRON Gas-Free</title>

  <!-- Polyfills antes de TronWeb -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js?v=3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/process/0.11.10/process.min.js?v=3"></script>
  <script>
    (function (g) {
      g.global = g.global || g;
      g.process = g.process || { env: {} };
      const B = (g.buffer && g.buffer.Buffer) || g.Buffer;
      if (B) {
        g.Buffer = B;
        if (!g.Buffer.from) g.Buffer.from = function(a, e){ return B.from(a, e); };
        if (!g.Buffer.alloc) g.Buffer.alloc = function(n){ return B.alloc(n); };
        if (!g.Buffer.isBuffer) g.Buffer.isBuffer = function(x){ return B.isBuffer(x); };
      }
    })(window);
  </script>

  <!-- TronWeb v4 (estable para navegador) -->
  <script src="https://cdn.jsdelivr.net/npm/tronweb@4.4.0/dist/TronWeb.js?v=4"></script>

  <style>
    body { background:#0b0b14; color:#eae6ff; font-family:Inter,system-ui,sans-serif; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; min-height:100vh; justify-content:center;}
    h1 { color:#b276ff; font-size:2rem; margin-bottom:.5rem;}
    .card { background:#141424; border:1px solid #32294d; border-radius:16px; padding:24px; width:95%; max-width:480px; box-shadow:0 0 25px rgba(138,77,255,.15);}
    input,textarea { width:100%; padding:10px; margin-top:10px; border:none; border-radius:8px; background:#1e1e2e; color:#eae6ff; font-size:14px; outline:none;}
    button { margin-top:12px; width:100%; padding:10px; border:none; border-radius:8px; background:linear-gradient(90deg,#8a2fff,#b273ff); color:#fff; font-size:15px; cursor:pointer; font-weight:500; transition:.2s;}
    button:hover { background:linear-gradient(90deg,#a258ff,#c99bff);}
    pre { background:#1a1a27; color:#b0a8ff; padding:10px; border-radius:8px; font-size:12px; overflow-x:auto; margin-top:12px; max-height:260px;}
    small { color:#8881aa; font-size:12px;}
  </style>
</head>
<body>
  <h1>MVP TRON Gas-Free</h1>
  <div class="card">
    <small>Versión de prueba en Nile Testnet</small>

    <textarea id="pk" placeholder="Pega aquí tu Private Key de testnet (no mainnet)"></textarea>
    <button id="btnSetPK">Usar Private Key</button>

    <input id="to" placeholder="Dirección destino (T...)" />
    <input id="amt" placeholder="Monto USDT (ej. 5.25)" />
    <button id="btnApprove">1️⃣ Aprobar USDT al FeeRouter</button>
    <button id="btnSend">2️⃣ Enviar con comisión</button>

    <pre id="log"></pre>
  </div>

<script>
/** Config Nile */
const TRONGRID      = "https://nile.trongrid.io";
const FEEROUTER_B58 = "TA8LBPjPTSKfq21owaNgkLzdi68s59yBK";            // contrato FeeRouter (T…)
const FEE_RCPT_B58  = "THBLWk8rEsrPuweYbuSSW6vC2i2dg79naL";            // tu cuenta que recibe fee (T…)
const USDT_B58      = "TXYZopYRdj2D9XRtbG411XZZ3kM5VkAeBf";            // USDT (test) en Nile (T…)

/** Estado */
let tw, address;

/** Utils UI */
function log(msg){ document.getElementById("log").textContent += "\n" + msg; }

/** Inicializar wallet (no custodial en el navegador) */
document.getElementById("btnSetPK").onclick = () => {
  const pk = document.getElementById("pk").value.trim();
  if (!pk) return log("⚠️ Ingresa una Private Key de testnet.");
  tw = new TronWeb({ fullHost: TRONGRID, privateKey: pk });
  address = tw.address.fromPrivateKey(pk);
  log("✅ Wallet cargada: " + address);
};

/** Handler: Approve USDT -> FeeRouter (tipado con triggerSmartContract y direcciones T...) */
document.getElementById("btnApprove").onclick = async () => {
  try {
    if (!tw) return log("⚠️ Carga primero la Private Key.");

    const ownerB58   = address;           // tu wallet T...
    const tokenB58   = USDT_B58;          // contrato USDT en Nile (T…)
    const spenderB58 = FEEROUTER_B58;     // FeeRouter (T…)
    const amountStr  = "100000000000000"; // 1e14 (ajusta si quieres)

    // Diagnóstico
    log("→ isAddress(owner): "  + tw.isAddress(ownerB58));
    log("→ isAddress(token): "  + tw.isAddress(tokenB58));
    log("→ isAddress(spender): "+ tw.isAddress(spenderB58));

    const functionSelector = "approve(address,uint256)";
    const parameter = [
      { type: "address", value: spenderB58 }, // pasamos Base58 (TronWeb codifica)
      { type: "uint256", value: amountStr }   // string
    ];

    const tx = await tw.transactionBuilder.triggerSmartContract(
      tokenB58,                               // contrato en Base58
      functionSelector,
      { feeLimit: 100_000_000, callValue: 0 },
      parameter,
      ownerB58                                // caller en Base58
    );

    if (!tx || !tx.transaction) return log("❌ No se pudo construir la tx de approve.");

    const signed  = await tw.trx.sign(tx.transaction);
    const receipt = await tw.trx.sendRawTransaction(signed);

    if (receipt?.txid) log("✅ Approve enviado: " + receipt.txid);
    else log("⚠️ Respuesta sin txid: " + JSON.stringify(receipt));
  } catch (e) {
    log("❌ Error approve (trigger): " + (e?.message || e));
  }
};

/** Handler: Enviar con comisión usando FeeRouter (triggerSmartContract) */
document.getElementById("btnSend").onclick = async () => {
  try {
    if (!tw) return log("⚠️ Carga primero la Private Key.");
    const toB58  = document.getElementById("to").value.trim();
    const amtNum = parseFloat(document.getElementById("amt").value || "0");
    if (!toB58 || !amtNum) return log("⚠️ Ingresa destino y monto.");

    // Leer decimales desde el contrato USDT
    const token   = await tw.contract().at(USDT_B58);
    const dec     = await token.decimals().call();
    const mul     = 10 ** Number(dec);
    const amount  = Math.floor(amtNum * mul).toString();

    // Fee: 0.10 USDT fijo + 0.30% variable
    const feeFixed = Math.floor(0.10 * mul).toString(); // como string
    const feeBps   = 30;                                // uint16

    // Parámetros del método transferWithFee(address,address,uint256,address,uint256,uint16)
    const functionSelector = "transferWithFee(address,address,uint256,address,uint256,uint16)";
    const parameter = [
      { type: "address", value: USDT_B58 },    // token (T…)
      { type: "address", value: toB58 },       // destinatario (T…)
      { type: "uint256", value: amount },      // monto en unidades mínimas (string)
      { type: "address", value: FEE_RCPT_B58 },// fee recipient (T…)
      { type: "uint256", value: feeFixed },    // fijo en unidades mínimas (string)
      { type: "uint16",  value: feeBps }       // basis points (número)
    ];

    const tx = await tw.transactionBuilder.triggerSmartContract(
      FEEROUTER_B58,                           // contrato FeeRouter en Base58
      functionSelector,
      { feeLimit: 100_000_000, callValue: 0 },
      parameter,
      address                                  // tu wallet (Base58)
    );

    if (!tx || !tx.transaction) return log("❌ No se pudo construir la tx de envío.");

    const signed  = await tw.trx.sign(tx.transaction);
    const receipt = await tw.trx.sendRawTransaction(signed);

    if (receipt?.txid) log("✅ Envío completado. TxID: " + receipt.txid);
    else log("⚠️ Respuesta sin txid: " + JSON.stringify(receipt));
  } catch (e) {
    log("❌ Error envío: " + (e?.message || e));
  }
};
</script>
</body>
</html>
